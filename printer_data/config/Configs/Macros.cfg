#####################################################################

# 	Misc Macros
#####################################################################

[gcode_macro MAUNAL_HEAT_SOAK]
gcode:
  M104 S150
  M190 S115
  SET_FAN_SPEED FAN=sEPERATOR SPEED=1

# params_park_x: 38.20
# params_park_y: 4.40
# params_park_z: 248.700

#:::::::::::::::::::::::::

[gcode_macro _set_fan_based_on_bed_temp]
gcode:
  {% set bed_temp = printer.heater_bed.temperature %}
  {% if bed_temp < 35 %}
    SET_FAN_SPEED FAN=sEPERATOR SPEED=0.0 ; Bed temp at IDLE/Cold plate
  {% elif bed_temp <74 %}
    SET_FAN_SPEED FAN=sEPERATOR SPEED=0.6 ; PLA
  {% elif bed_temp < 85 %}
    SET_FAN_SPEED FAN=sEPERATOR SPEED=1.0 ; PETG, Nylon & TPU
  {% elif bed_temp < 105 %}
    SET_FAN_SPEED FAN=sEPERATOR SPEED=1.0 ; ABS & ASA
  {% elif bed_temp > 105 %}
    SET_FAN_SPEED FAN=sEPERATOR SPEED=1.0 ; HT Filaments & Engineering Plates
  {% endif %}
  
#:::::::::::::::::::::::::

[gcode_macro _PRINT_START_LEDs]
gcode:
  SET_PIN PIN=caselight VALUE=1.000
  
  SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.196 INDEX=1 ; Logo
  SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=1.000 INDEX=2 ; Nozzle Left
  SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=1.000 INDEX=3 ; Nozzle Right

  SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.196 INDEX=1 ; Logo
  SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=1.000 INDEX=2 ; Nozzle Left
  SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=1.000 INDEX=2 ; Nozzle Right

  # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.196 INDEX=1 ; Logo
  # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=1.000 INDEX=2 ; Nozzle Left
  # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=1.000 INDEX=2 ; Nozzle Right

  # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.196 INDEX=1 ; Logo
  # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=1.000 INDEX=2 ; Nozzle Left
  # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=1.000 INDEX=2 ; Nozzle Right

[gcode_macro PRINT_COMPLETE_LEDs]
gcode:
  SET_LED LED=STB0_leds RED=0.000 GREEN=0.430 BLUE=0.000 WHITE=0.050 TRANSMIT=1
  SET_LED LED=STB1_leds RED=0.000 GREEN=0.430 BLUE=0.000 WHITE=0.050 TRANSMIT=1
  # SET_LED LED=STB2_leds RED=0.000 GREEN=0.430 BLUE=0.000 WHITE=0.050 TRANSMIT=0
  # SET_LED LED=STB3_leds RED=0.000 GREEN=0.430 BLUE=0.000 WHITE=0.050 TRANSMIT=0

  SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1  TRANSMIT=1 ; Logo
  SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1  TRANSMIT=1 ; Logo
  # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 ; Logo
  # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 ; Logo
  
[gcode_macro LIGHTSOUT]
gcode:
  SET_PIN PIN=caselight VALUE=0.000
  
  SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 ; Logo
  SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=2 ; Nozzle Left
  SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=3 ; Nozzle Right

  SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 ; Logo
  SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=2 ; Nozzle Left
  SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=3 ; Nozzle Right

  # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 ; Logo
  # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=2 ; Nozzle Left
  # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=3 ; Nozzle Right

  # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 ; Logo
  # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=2 ; Nozzle Left
  # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=3 ; Nozzle Right

[gcode_macro PRINGTING_LIGHTS]
gcode:
  SET_PIN PIN=caselight VALUE=1.000
  
  SET_LED LED=STB0_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=2 ; Nozzle Left
  SET_LED LED=STB0_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=3 ; Nozzle Right

  SET_LED LED=STB1_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=2 ; Nozzle Left
  SET_LED LED=STB1_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=3 ; Nozzle Right

  # SET_LED LED=STB2_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=2 ; Nozzle Left
  # SET_LED LED=STB2_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=3 ; Nozzle Right

  # SET_LED LED=STB3_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=2 ; Nozzle Left
  # SET_LED LED=STB3_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=3 ; Nozzle Right

[gcode_macro PRINGTING_LIGHTS_OFF]
gcode:
  SET_PIN PIN=caselight VALUE=0.000
  
  SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=2 ; Nozzle Left
  SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=3 ; Nozzle Right

  SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=2 ; Nozzle Left
  SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=3 ; Nozzle Right

  # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=2 ; Nozzle Left
  # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=3 ; Nozzle Right

  # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=2 ; Nozzle Left
  # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=3 ; Nozzle Right

[gcode_macro SET_SEALTHBURNER_LOGO]
description:
                              Schemes
####################################################################
  "OFF"
  "Draft Shift Design"
  "CU Boulder"
  "UW Madison"
  "Dim White"
  "WHITE"
  "Yellow"
  "Royal Purple"
  "Baby Blue"
  "Pink"
####################################################################
         
gcode:
    {% set scheme = params.SCHEME | default("OFF") %}
    {% if scheme == "OFF" %}
        SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 TRANSMIT=1
    {% elif scheme == "Draft Shift Design" %}
        SET_LED LED=STB0_leds RED=0.784 GREEN=0.302 BLUE=0.247 WHITE=0.000 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=0.784 GREEN=0.302 BLUE=0.247 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=0.784 GREEN=0.302 BLUE=0.247 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=0.784 GREEN=0.302 BLUE=0.247 WHITE=0.000 INDEX=1 TRANSMIT=1
    {% elif scheme == "CU Boulder" %}
        SET_LED LED=STB0_leds RED=0.812 GREEN=0.722 BLUE=0.486 WHITE=0.000 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=0.812 GREEN=0.722 BLUE=0.486 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=0.812 GREEN=0.722 BLUE=0.486 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=0.812 GREEN=0.722 BLUE=0.486 WHITE=0.000 INDEX=1 TRANSMIT=1
    {% elif scheme == "UW Madison" %}
        SET_LED LED=STB0_leds RED=0.772 GREEN=0.020 BLUE=0.047 WHITE=0.000 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=0.772 GREEN=0.020 BLUE=0.047 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=0.772 GREEN=0.020 BLUE=0.047 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=0.772 GREEN=0.020 BLUE=0.047 WHITE=0.000 INDEX=1 TRANSMIT=1
    {% elif scheme == "Dim White" %}
        SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.196 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.196 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.196 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.196 INDEX=1 TRANSMIT=1
    {% elif scheme == "WHITE" %}
        SET_LED LED=STB0_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=1.000 GREEN=1.000 BLUE=1.000 WHITE=1.000 INDEX=1 TRANSMIT=1
    {% elif scheme == "Mint Green" %}
        SET_LED LED=STB0_leds RED=0.596 GREEN=1.000 BLUE=0.557 WHITE=0.000 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=0.596 GREEN=1.000 BLUE=0.557 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=0.596 GREEN=0.973 BLUE=0.557 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=0.596 GREEN=0.973 BLUE=0.557 WHITE=0.000 INDEX=1 TRANSMIT=1
    {% elif scheme == "Yellow" %}
        SET_LED LED=STB0_leds RED=1.000 GREEN=0.647 BLUE=0.000 WHITE=0.153 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=1.000 GREEN=0.647 BLUE=0.000 WHITE=0.153 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=1.000 GREEN=0.647 BLUE=0.000 WHITE=0.153 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=1.000 GREEN=0.647 BLUE=0.000 WHITE=0.153 INDEX=1 TRANSMIT=1
    {% elif scheme == "Royal Purple" %}
        SET_LED LED=STB0_leds RED=0.451 GREEN=0.051 BLUE=0.725 WHITE=0.000 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=0.451 GREEN=0.051 BLUE=0.725 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=0.451 GREEN=0.051 BLUE=0.725 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=0.451 GREEN=0.051 BLUE=0.725 WHITE=0.000 INDEX=1 TRANSMIT=1
    {% elif scheme == "Baby Blue" %}
        SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=1.000 WHITE=0.000 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=1.000 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=1.000 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=1.000 WHITE=0.000 INDEX=1 TRANSMIT=1
    {% elif scheme == "Pink" %}
        SET_LED LED=STB0_leds RED=1.000 GREEN=0.000 BLUE=0.000 WHITE=0.196 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=1.000 GREEN=0.000 BLUE=0.000 WHITE=0.196 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=1.000 GREEN=0.00 BLUE=0.000 WHITE=0.196 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=1.000 GREEN=0.000 BLUE=0.000 WHITE=0.196 INDEX=1 TRANSMIT=1
    {% else %}
        # If an invalid scheme is selected, default to OFF
        SET_LED LED=STB0_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 TRANSMIT=1
        SET_LED LED=STB1_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB2_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 TRANSMIT=1
        # SET_LED LED=STB3_leds RED=0.000 GREEN=0.000 BLUE=0.000 WHITE=0.000 INDEX=1 TRANSMIT=1
    {% endif %}

#:::::::::::::::::::::::::

[gcode_macro probe_break_in]
gcode:
  _G32 ; Home and GQL
  G1 X152.5 Y152.5 F15000 ; Move to Center for Probing
  {% set tn = params.TN|string %}
  {% set tool = printer['tool ' + tn] %}
  PROBE_ACCURACY SAMPLES=1000 SAMPLE_RETRACT_DIST=3.5 ; Probe 2500 times lifting up 3.5mm between each
  _TOOL_PICKUP {rawparams}

#:::::::::::::::::::::::::

[gcode_macro update_git]
gcode:
    {% set message = params.MESSAGE|default() %}
    {% if message %}
        RUN_SHELL_COMMAND CMD=update_git_script_message PARAMS="'{params.MESSAGE}'"
    {% else %}
        RUN_SHELL_COMMAND CMD=update_git_script
    {% endif %}

[gcode_shell_command update_git_script]
command: bash -c "bash $HOME/klipper-backup/script.sh"
timeout: 90.0
verbose: True

[gcode_shell_command update_git_script_message]
command: bash -c "bash $HOME/klipper-backup/script.sh -c \"$0\""
timeout: 90.0
verbose: True

#:::::::::::::::::::::::::

# [gcode_macro VENTED_PRINT_END]
# gcode:
#     # Lift the nozzle by 10mm but not above 275mm
#   G91 ; Set to relative positioning
#   G0 Z10 ; Move Z up by 10mm
#   G0 E-5 ; Retract filament at end of print
#   G92 E0 ; Zero the extruder

#   G28 X Y ; Send Print head to 300,300
#   LIGHTSOUT ; 
  
#   M84 ; Disable Steppers
#   M104 S0 ; Turn off extruder
#   M140 S0 ; Turn off bed
#   M191 R40 ; Wait untill chamber reaches 40
  
#   SET_FAN_SPEED FAN=exhaust SPEED=.25
  
#   M191 R35 ; Wait untill chamber reaches 35
#   SET_FAN_SPEED FAN=exhaust SPEED=0.000 ; Turn off exhaust
#   SET_FAN_SPEED FAN=sEPERATOR SPEED=0.000 ; Turn off SEPERATOR
  
#   M117 Print & Vent Complete
